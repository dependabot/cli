# Tests related to running the Proxy

exec docker build -qt proxy-updater .
exec docker build -qt dummy-proxy -f Dockerfile.proxy .

# Test with credentials (proxy should run)
dependabot update -f job.yml --updater-image proxy-updater --proxy-image dummy-proxy
stderr 'proxy \| Proxy is running'
stderr 'updater \| Updater is running'
! stderr 'proxy \| custom-ca-cert\.crt'

dependabot update -f job.yml --proxy-cert my-cert --updater-image proxy-updater --proxy-image dummy-proxy
stderr 'proxy \| custom-ca-cert\.crt'
stderr 'proxy \| I am a certificate'

# Test that the CLI exits with non-zero if the proxy does too.
! dependabot update -f job.yml --proxy-cert crash --updater-image proxy-updater --proxy-image dummy-proxy

# Test without credentials (proxy should NOT run)
dependabot update -f job-no-creds.yml --updater-image proxy-updater --proxy-image dummy-proxy
! stderr 'proxy \| Proxy is running'
stderr 'updater \| Updater is running'

exec docker rmi -f proxy-updater dummy-proxy

-- job.yml --
job:
  package-manager: go_modules
  allowed-updates:
    - update-type: all
  source:
    provider: github
    repo: dependabot/cli
    directory: /
credentials:
  - type: git_source
    host: github.com
    username: x-access-token
    password: dummy_token

-- job-no-creds.yml --
job:
  package-manager: go_modules
  allowed-updates:
    - update-type: all
  source:
    provider: github
    repo: dependabot/cli
    directory: /

-- crash --
crash

-- my-cert --
I am a certificate

-- Dockerfile.proxy --
FROM ubuntu:22.04

COPY --chmod=755 update-ca-certificates /usr/bin/update-ca-certificates
COPY --chmod=755 update-job-proxy /update-job-proxy

-- update-job-proxy --
#!/usr/bin/env bash

echo "Proxy is running"
echo "$(</config.json)"

-- Dockerfile --
FROM ubuntu:22.04

RUN useradd dependabot

COPY --chown=dependabot --chmod=755 update-ca-certificates /usr/bin/update-ca-certificates
COPY --chown=dependabot --chmod=755 run bin/run

-- update-ca-certificates --
#!/usr/bin/env bash

ls /usr/local/share/ca-certificates || true
cat /usr/local/share/ca-certificates/custom-ca-cert.crt || true

# signal to cause the proxy to exit with a non-zero code
grep crash /usr/local/share/ca-certificates/custom-ca-cert.crt && exit 1 || true

-- run --
#!/usr/bin/env bash

echo "Updater is running"
